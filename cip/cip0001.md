---
author: "Neil D. Lawrence"
created: "2025-11-22"
id: "0001"
last_updated: "2025-11-22"
status: completed
tags:
- cip
- validation
- refactor
- quantum-game
title: "Consolidate and Document Quantum Inaccessible Game Validation Code"
---

# CIP-0001: Consolidate and Document Quantum Inaccessible Game Validation Code

## Summary

The current Python code for the quantum inaccessible game is spread across several modules (`inaccessible_game_quantum.py`, `advanced_analysis.py`, `validate_qutrit_optimality.py`, and `test_inaccessible_game.py`), plus accompanying documentation (`README_VALIDATION.md`, `QUICKSTART.md`, `TESTING.md`, `CODE_SUMMARY.md`, `IMPLEMENTATION_SUMMARY.md`).  
This CIP proposes to:

- Systematically **document the existing functionality and tests**.
- Introduce a **clear module structure and public API** for the quantum game code.
- Consolidate overlapping functionality and remove ad hoc experimental code paths.
- Make it easier to extend, test, and re-use the code when the paper evolves.

## Motivation

The quantum validation code was developed iteratively to support the paper *The Origin of the Inaccessible Game*. As a result:

- Core functionality (state preparation, operator bases, exponential family, constrained dynamics) lives alongside exploratory or experimental code (e.g. early qutrit optimality scripts).
- Tests cover many behaviours, but the mapping â€œwhich tests validate which behavioursâ€ is not documented in one place.
- There is no explicit â€œlibrary-styleâ€ API; scripts mix core logic, analysis, plotting, and CLI behaviour.

For future work (e.g. extending to new dimensions, alternate constraints, or different time parametrisations), we want:

- A **clean separation** between:
  - core quantum game logic;
  - analysis/visualisation;
  - numerical experiments for specific claims;
  - test harnesses.
- A **single place** where existing functionality and tests are described at a high level.

This will make the codebase easier to maintain, review, and re-use (for example, when referees request additional experiments, or when new collaborators join).

## Detailed Description

The existing codebase for the quantum inaccessible game includes at least the following components:

- `inaccessible_game_quantum.py`
  - Quantum state utilities (density matrices, von Neumann entropy, partial traces).
  - Operator bases (Pauli, Gell-Mann, and generalised Gell-Mann-like bases).
  - Quantum exponential family (`QuantumExponentialFamily`) and BKM/Fisher information.
  - Constrained dynamics (`InaccessibleGameDynamics`) supporting different time parametrisations (affine game time, entropy time, etc.).
- `advanced_analysis.py`
  - Higher-level analysis routines for:
    - comparing time parametrisations;
    - tracking GENERIC evolution (symmetric vs antisymmetric parts);
    - exploring qutrit vs qubit behaviour.
  - Mainly used as a script-like module for numerical experiments and visualisation.
- `validate_qutrit_optimality.py`
  - Experimental code for probing the qutrit optimality claim numerically.
  - Contains slow Fisher information computations and diagnostic output.
  - Partially exploratory and currently limited by numerical stability/speed.
- `test_inaccessible_game.py`
  - Comprehensive test suite for:
    - quantum state utilities and operator bases;
    - exponential family properties and BKM metric behaviour;
    - constrained dynamics (tangency, constraint preservation, entropy monotonicity);
    - GENERIC decomposition properties;
    - regression-style checks on small systems (2 qubits, 2 qutrits, 3 qutrits).
  - Includes fast tests and a set of `@pytest.mark.slow` integration/validation tests.

Supporting documentation:

- `README_VALIDATION.md`, `QUICKSTART.md`, `TESTING.md`, `CODE_SUMMARY.md`, `IMPLEMENTATION_SUMMARY.md`.
  - Describe at a high level what the code does, how to run the tests, how to run the validation experiments, and how the implementation matches the paper.

The aim of this CIP is to:

1. **Inventory and stabilise existing functionality**
   - Produce a concise, code-centric overview of:
     - modules and their responsibilities;
     - main classes/functions and their public APIs;
     - which tests validate which behaviours.
2. **Consolidate and simplify module structure**
   - Factor the code into a small number of clearly named modules, for example:
     - `qig/core.py` â€“ core data structures and utilities (states, entropy, partial trace).
     - `qig/exponential_family.py` â€“ `QuantumExponentialFamily` and BKM metric.
     - `qig/dynamics.py` â€“ `InaccessibleGameDynamics`, time parametrisations, GENERIC decomposition.
     - `qig/analysis.py` â€“ high-level analysis helpers used by scripts and notebooks.
   - Move script-like behaviour (CLI argument parsing, plotting, printing) into separate files under a `scripts/` or `experiments/` directory.
3. **Align tests with the refactored layout**
   - Make sure `test_inaccessible_game.py` (or a reorganised test package) still:
     - covers all critical behaviours (state utilities, operator bases, metrics, dynamics, GENERIC structure);
     - marks truly slow tests with `@pytest.mark.slow`;
     - documents, at the top of the file, the mapping from test classes/sections to modules/features.
4. **Update documentation to match the new structure**
   - Refresh `README_VALIDATION.md`, `QUICKSTART.md`, and `TESTING.md` so that:
     - module names and paths match the refactored code;
     - example commands use the new script locations and recommended workflows;
     - links to specific tests and functions point at the consolidated API.

## Implementation Plan

1. **Create a module layout and move core code**
   - Introduce a Python package namespace, e.g. `qig/` for quantum inaccessible game (or similar).
   - Move:
     - core utilities from `inaccessible_game_quantum.py` into `qig/core.py`;
     - exponential-family and metric code into `qig/exponential_family.py`;
     - constrained dynamics and GENERIC support into `quantum_game/dynamics.py`.
   - Leave `inaccessible_game_quantum.py` as a thin legacy wrapper (for backward compatibility) that imports from the new modules, or deprecate it with a clear note.

2. **Refactor analysis and experiment scripts**
   - Move reusable analysis functions from `advanced_analysis.py` into `qig/analysis.py`.
   - Turn `advanced_analysis.py` and `validate_qutrit_optimality.py` into:
     - thin CLI scripts in `scripts/` that call the core library;
     - or Jupyter notebooks that import from `qig/*` for exploratory work.
   - Clearly separate â€œlibrary codeâ€ from â€œone-off numerical experimentsâ€.

3. **Review and reorganise tests**
   - Survey `test_inaccessible_game.py` and document, in comments at the top:
     - which parts of the code each test section targets.
   - Optionally split into multiple files, e.g.:
     - `test_states_and_operators.py`
     - `test_exponential_family.py`
     - `test_dynamics_and_generic.py`
     - `test_validation_workflows.py`
   - Ensure that:
     - fast tests remain under `-m "not slow"`;
     - slow integration/validation tests are clearly marked and can be skipped by default.

4. **Update documentation**
   - Update `README_VALIDATION.md`, `QUICKSTART.md`, `TESTING.md`, `CODE_SUMMARY.md`, and `IMPLEMENTATION_SUMMARY.md` to:
     - reflect the new package layout and public APIs;
     - list the main entry points (classes/functions) and what they implement from the paper;
     - cross-reference the relevant tests for each major feature.

5. **Housekeeping and cleanup**
   - Remove or deprecate any dead code paths uncovered during the refactor.
   - Ensure that British English spellings remain consistent after renaming/moving.
   - Run the full test suite (fast + `slow`) and update any numerical tolerances if refactoring changes behaviour only within acceptable numerical error.

## Backward Compatibility

This refactor is mostly internal and aimed at improving structure and clarity. However:

- If external users are importing directly from `inaccessible_game_quantum.py`, we should:
  - either keep that file as a thin wrapper re-exporting the new modules;
  - or add a clear deprecation notice and a simple migration guide.
- CLI entry points (e.g. `python validate_qutrit_optimality.py`) may move to a `scripts/` directory; we should:
  - update all docs to point to the new locations;
  - consider adding a small wrapper script for backward compatibility if needed.

Overall, backward compatibility can be preserved with minimal shims and clear documentation.

## Testing Strategy

- Ensure that the existing tests in `test_inaccessible_game.py` (and any split-out test files) continue to pass after refactoring:
  - run `pytest -m "not slow"` frequently during refactor;
  - periodically run the full suite including `@pytest.mark.slow` tests.
- Add targeted tests if any new public API surface appears (e.g. new helper functions in `quantum_game/analysis.py`).
- Use CI (if available) or at least a consistent local test command documented in `TESTING.md`.

## Related Requirements

This CIP addresses the following high-level needs:

- Make the quantum inaccessible game codebase easier to understand and extend.
- Provide a clear mapping from paper statements to implementation and tests.
- Reduce friction when adding new numerical experiments or responding to referee requests.
- Prepare the ground for more advanced geometric work (analytic BKM metric, full Jacobian,
  higher-order cumulants) and their supporting documentation.

Specific requirements implemented by this CIP include:

- A documented and stable module structure for the quantum game code.
- A clear separation between core library functionality and experiment/analysis scripts.
- A documented test plan tied to specific features of the implementation.

## Implementation Status

**Core refactoring (COMPLETED âœ…):**
- [x] Agree on final package/module naming (`qig` for the quantum inaccessible game)
- [x] Move initial core logic (state utilities and entropy helpers) into package modules
- [x] Migrate the main library classes (`QuantumExponentialFamily`, `InaccessibleGameDynamics`) into `qig.exponential_family` and `qig.dynamics`
- [x] Refactor core analysis/experiment scripts to use the new `qig` API

**New implementations (COMPLETED âœ…):**
- [x] **Created `qig/pair_operators.py`**: Clean separation of pair-based operators
  - `gell_mann_generators(d)`: General su(d) generators
  - `pair_basis_generators(d)`: su(dÂ²) for entangled pairs
  - `bell_state()`, `bell_state_density_matrix()`: Maximally entangled states
  - `multi_pair_basis()`: Direct sum structure for n independent pairs

- [x] **Created `qig/duhamel.py`**: High-precision quantum derivatives
  - Duhamel integral for âˆ‚Ï/âˆ‚Î¸ (machine precision)
  - Eliminates Hermiticity errors from classical formulas

- [x] **Enhanced `qig/exponential_family.py`**:
  - Added `pair_basis=True` mode for entangled systems
  - New methods: `von_neumann_entropy()`, `mutual_information()`, `purity()`
  - Corrected `jacobian()` for full formula (not simplified)
  - Updated `marginal_entropy_constraint()` with `method='duhamel'`
  - All quantum gradients implemented analytically with high precision

**Comprehensive testing (COMPLETED âœ…):**
- [x] **Created `test_pair_exponential_family.py`** (16 tests):
  - Initialization for 1-2 pairs, qubits and qutrits
  - Operator properties (Hermitian, traceless)
  - Density matrix properties
  - Entanglement metrics validation
  - Block-diagonal Fisher metric (cross-pair ~10â»Â¹â¶)
  - Computational scaling verification

- [x] **Created `test_pair_numerical_validation.py`** (10 tests):
  - âˆ‚Ï/âˆ‚Î¸ validation: ~1-3Ã—10â»âµ error
  - Fisher metric G: ~4Ã—10â»â´ error
  - Constraint gradient âˆ‡C: ~9Ã—10â»â¶ error
  - Constraint Hessian âˆ‡Â²C: ~6Ã—10â»â´ error
  - **Jacobian M: ~1.3Ã—10â»âµ error**
  - Dynamics verification: F â‰  0, GÎ¸ â‰  -a for entangled systems

**Documentation (COMPLETED âœ…):**
- [x] Backlog tasks with comprehensive progress updates:
  - `2025-11-22_entangled-pair-exponential-family.md` (Completed)
  - `2025-11-22_analytic-jacobian-implementation.md` (Completed)
- [x] Working verification code examples demonstrating:
  - Entanglement and structural identity breaking
  - Jacobian numerical validation
  - Gradient comparison âˆ‡C vs âˆ‡H

**Critical remaining work (IN PROGRESS):**
- [ ] **Audit and update legacy dynamics scripts**:
  - [ ] Check `inaccessible_game_quantum.py` - uses local operators (no entanglement possible!)
  - [ ] Check `advanced_analysis.py` - time parametrization experiments with local operators
  - [ ] Check `validate_qutrit_optimality.py` - qutrit optimality with local operators
  - [ ] **Key question**: Were these scripts supposed to study entangled systems?
    - If YES â†’ Need to update to use `pair_basis=True` and su(dÂ²) operators
    - If NO â†’ Document that they study separable states only
  - [ ] Verify all dynamics experiments produce expected results with pair operators
  - [ ] Test that trajectory integration works with corrected Jacobian
  - [ ] Update any hardcoded assumptions about Î½ = -1 or GÎ¸ = -a

- [ ] **Legacy test validation**:
  - [ ] Audit `test_inaccessible_game.py` (726 lines) for local-operator assumptions
  - [ ] Verify GENERIC decomposition tests work with pair operators
  - [ ] Check if any tests need updating for entangled systems
  - [ ] Optionally split into focused test modules

- [ ] **Documentation updates**:
  - [ ] Update validation documentation (README_VALIDATION.md, QUICKSTART.md, etc.)
  - [ ] Document which experiments use local vs pair operators
  - [ ] Add migration guide for updating scripts to pair basis
  - [ ] Document mapping from all test classes to modules/features

**Key achievements:**
- âœ… Clean module structure with clear separation of concerns
- âœ… 26 new tests (all passing) with tight tolerances
- âœ… Pair-based operators enable genuine entanglement (I > 0)
- âœ… Analytic Jacobian validated for both local and pair systems
- âœ… Fisher metric block-diagonal structure confirmed
- âœ… Verification code examples in documentation

**Status: ACCEPTED (In Progress)** - Core refactoring complete. **Critical remaining work**: Audit and update legacy dynamics scripts (`inaccessible_game_quantum.py`, `advanced_analysis.py`, `validate_qutrit_optimality.py`) which currently use local operators only and cannot study entangled systems. These scripts need checking and potentially updating to use the new pair basis.

## Legacy Script Migration Checklist

**URGENT**: The following legacy scripts need auditing and potentially updating for entangled systems:

**Legacy scripts (7 files total):**
1. `inaccessible_game_quantum.py` - Core quantum game with local operators
2. `advanced_analysis.py` - Time parametrization analysis
3. `validate_qutrit_optimality.py` - Qutrit optimality with local operators
4. `quantum_qutrit_n3.py` - **Custom qutrit implementation** (doesn't use `qig`!)
5. `run_qutrit_experiment.py` - Uses `quantum_qutrit_n3.py`
6. `run_qutrit_quick.py` - Uses `quantum_qutrit_n3.py`
7. `test_quantum_qutrit.py` - Tests for custom qutrit code

**All of these potentially use LOCAL operators only** and may not be able to study entangled systems!

### `inaccessible_game_quantum.py`
- **Current state**: Uses local operator basis (Pauli, Gell-Mann)
- **Problem**: `QuantumExponentialFamily` with default initialization â†’ separable states only
- **Action needed**:
  1. Check if any dynamics experiments assume entanglement exists
  2. If studying entangled systems â†’ convert to `pair_basis=True`
  3. Update `InaccessibleGameDynamics` if it makes assumptions about Î½ = -1 or GÎ¸ = -a
  4. Verify trajectory integration works with corrected Jacobian

### `advanced_analysis.py`
- **Current state**: Time parametrization comparisons with local operators
- **Questions to answer**:
  1. Are the time parametrization experiments supposed to study entangled states?
  2. Does entropy-time reparametrization change when C â‰  H (entanglement present)?
  3. Do GENERIC decomposition results change with pair operators?
- **Action needed**:
  1. Document whether experiments study separable or entangled systems
  2. If entangled â†’ update to pair basis and re-run experiments
  3. Update any plots/analysis that assume I = 0

### `validate_qutrit_optimality.py`
- **Current state**: Qutrit optimality claim with local operators (`QuantumExponentialFamily(n_sites, d)`)
- **Critical question**: Can qutrits be "optimal" if we can't create entanglement?
- **Action needed**:
  1. Check paper: Is qutrit optimality about entangled qutrit pairs?
  2. If yes â†’ **must use pair basis** with su(9) generators (80 parameters)
  3. Re-run optimality experiments with genuine entanglement
  4. Verify Fisher information computations with pair operators

### `quantum_qutrit_n3.py` + experiment runners
- **Current state**: Custom qutrit implementation, does NOT use `qig` modules!
  - Has its own Gell-Mann matrices, exponential family, Fisher metric
  - Used by `run_qutrit_experiment.py` and `run_qutrit_quick.py`
- **Problem**: Completely separate codebase, hard to maintain
- **Action needed**:
  1. **Audit implementation**: Does it use local or pair operators?
  2. **Decision point**: 
     - Migrate to use `qig.exponential_family` with pair basis?
     - Or keep as standalone reference implementation?
  3. If migrating:
     - Replace custom code with `QuantumExponentialFamily(n_pairs=N, d=3, pair_basis=True)`
     - Update `run_qutrit_experiment.py` and `run_qutrit_quick.py`
     - Verify results match before/after migration
  4. If keeping separate:
     - Document why it's separate
     - Ensure it correctly handles entanglement (if needed)

### General migration steps:

**Phase 1: Audit (CRITICAL)**
1. **Check paper**: What do experiments claim to study?
   - Separable states only? â†’ Local operators are correct
   - Entangled pairs? â†’ **Must use pair operators**
2. **Check each script's initialization**:
   ```python
   # Search for patterns like:
   QuantumExponentialFamily(n_sites=..., d=...)  # â† Local operators
   # vs
   QuantumExponentialFamily(n_pairs=..., d=..., pair_basis=True)  # â† Pair operators
   ```
3. **Check for hardcoded assumptions**:
   - Î½ = -1 (only true for local operators)
   - GÎ¸ = -a (structural identity, only holds for local operators)
   - I = 0 or C = H (only true without entanglement)

**Phase 2: Migration (if needed)**
1. **Update initialization** for entangled systems:
   ```python
   # Old (local operators, NO entanglement possible)
   exp_fam = QuantumExponentialFamily(n_sites=2, d=3)  # 2 qutrits, 16 params
   
   # New (pair operators, entanglement possible)
   exp_fam = QuantumExponentialFamily(n_pairs=1, d=3, pair_basis=True)  # 1 qutrit pair, 80 params
   ```

2. **Update dynamics code**:
   - Remove hardcoded Î½ = -1
   - Remove hardcoded GÎ¸ = -a
   - Use `jacobian(theta, method='duhamel')` for corrected Jacobian

3. **Update analysis code**:
   - Check for I > 0 (entanglement present)
   - Use âˆ‡C â‰  âˆ‡H (different gradients for entangled systems)
   - Update plots/visualizations for entanglement metrics

**Phase 3: Validation**
1. **Re-run experiments** with updated code
2. **Compare results** with paper claims
3. **Document changes** in commit messages
4. **Update paper if needed** (if old results were wrong)

## Final Module Structure

The refactored codebase now has the following clean structure:

**Core Library (`qig/` package):**
- `qig/core.py` - State utilities, entropy, partial traces
- `qig/exponential_family.py` - `QuantumExponentialFamily` with BKM metric, Jacobian, constraints
  - Supports both local operators (separable states) and pair operators (entangled states)
  - Methods: `rho_from_theta()`, `fisher_information()`, `jacobian()`, `mutual_information()`, etc.
- `qig/pair_operators.py` - su(dÂ²) generators for entangled pairs
  - `gell_mann_generators()`, `pair_basis_generators()`, `bell_state()`, `multi_pair_basis()`
- `qig/duhamel.py` - High-precision quantum derivatives
  - Duhamel integral for machine-precision âˆ‚Ï/âˆ‚Î¸

**Test Suite:**
- `test_inaccessible_game.py` - Legacy comprehensive tests (726 lines)
- `test_pair_exponential_family.py` - 16 tests for pair basis functionality
- `test_pair_numerical_validation.py` - 10 numerical validation tests
- `test_third_cumulant.py` - Third cumulant validation
- `test_constraint_hessian.py` - Constraint Hessian validation
- `test_lagrange_multiplier_gradient.py` - Lagrange multiplier gradient tests
- `test_jacobian.py` - Jacobian validation
- Various BKM metric tests

**Total: 26+ comprehensive tests covering all quantum gradients with tight tolerances (~10â»âµ)**

## Key Achievements

1. **Clear API separation**: Local operators vs pair operators
   ```python
   # Local operators (separable states only)
   exp_fam_local = QuantumExponentialFamily(n_sites=2, d=2, pair_basis=False)
   
   # Pair operators (can create entanglement)
   exp_fam_pairs = QuantumExponentialFamily(n_pairs=1, d=2, pair_basis=True)
   ```

2. **High-precision quantum derivatives**:
   - âˆ‚Ï/âˆ‚Î¸: ~1-3Ã—10â»âµ error (Duhamel method)
   - Fisher G: ~4Ã—10â»â´ error, block-diagonal ~10â»Â¹â¶
   - Jacobian M: ~1.3Ã—10â»âµ error

3. **Validated entanglement capability**:
   - Local operators: I = 0 always (C = H)
   - Pair operators: I > 0 (genuine entanglement)
   - Structural identity GÎ¸ = -a breaks for entangled systems

4. **Comprehensive documentation**:
   - Backlog tasks with working verification examples
   - Clear progress updates tracking implementation
   - Code examples that users can run to verify behavior

## References

**Code:**
- Core: `qig/core.py`, `qig/exponential_family.py`, `qig/pair_operators.py`, `qig/duhamel.py`
- Legacy: `inaccessible_game_quantum.py`, `advanced_analysis.py`, `validate_qutrit_optimality.py`
- Tests: `test_pair_exponential_family.py`, `test_pair_numerical_validation.py`, `test_inaccessible_game.py`

**Documentation:**
- Backlog: `backlog/features/2025-11-22_entangled-pair-exponential-family.md` (Completed)
- Backlog: `backlog/infrastructure/2025-11-22_analytic-jacobian-implementation.md` (Completed)
- Paper: *The Origin of the Inaccessible Game* (LaTeX draft)

**Related Work (now completed):**
- âœ… `2025-11-22_remove-numerical-gradients` - All gradients now analytic
- âœ… `2025-11-22_analytic-jacobian-implementation` - Full Jacobian implemented
- âœ… `2025-11-22_entangled-pair-exponential-family` - Pair basis implemented
- ðŸ”„ `2025-11-22_qig-docs-and-tests-refactor` - Remaining: update validation docs


