---
author: "Neil D. Lawrence"
created: "2025-11-25"
id: "0004"
last_updated: "2025-12-01"
status: implemented
tags:
- cip
- testing
- refactoring
- quality-assurance
title: "Comprehensive Test Suite Rewrite with Rigorous Tolerances"
---

# CIP-0004: Comprehensive Test Suite Rewrite with Rigorous Tolerances

## Summary

The current test suite consists of 19 test files with inconsistent tolerances, unclear test organisation, and questionable numerical precision expectations. This CIP proposes a complete rewrite of the test suite that:

- **Standardises numerical tolerances** based on rigorous error analysis
- **Reorganises test structure** for better maintainability and coverage clarity
- **Maintains identical test coverage** while improving reliability and documentation
- **Establishes tolerance guidelines** based on mathematical precision bounds

## Motivation

The current test suite has several critical issues:

### Tolerance Inconsistencies
- Tolerances range from `1e-14` (near machine precision) to `1e-4` (4 decimal places)
- No clear rationale for tolerance choices
- Some tests use absolute tolerances, others relative, some both
- Inconsistent error bounds across similar mathematical operations

### Test Organisation Problems

- 19 test files with unclear division of responsibility
- Overlapping coverage between `test_inaccessible_game.py` (726 lines) and specialised files
- No clear mapping between tests and mathematical requirements
- Poor separation between unit tests, integration tests, and validation tests

### Numerical Precision Issues

- Tests assume numerical methods are more accurate than they actually are
- No consideration of floating-point error accumulation
- Missing error propagation analysis for complex computations

### Maintenance Burden

- Tests are hard to debug when tolerances are too strict or inconsistent
- Difficult to determine if test failures indicate real bugs or tolerance issues
- Poor documentation of what each tolerance actually validates

## Detailed Description

This CIP will establish a new test suite that maintains complete coverage while providing:

### 1. Rigorous Tolerance Framework

- **Mathematical error bounds** based on quantum algorithm precision analysis
- **Machine epsilon awareness** for floating-point operations
- **Error propagation tracking** through complex computations
- **Statistical validation** of numerical tolerances

### 2. Hierarchical Test Structure

- **Unit tests**: Core mathematical operations with tight tolerances
- **Integration tests**: End-to-end workflows with appropriate numerical bounds
- **Validation tests**: Physical/mathematical correctness with statistically meaningful thresholds

### 3. Scientifically Derived Tolerance Categories

Tolerance categories are derived from quantum algorithm precision analysis:

**Category A: Machine Precision Operations (≤ 1e-14)**

- **Mathematical basis**: Direct machine epsilon bounds (ε ≈ 2.22e-16)
- **Operations**: Matrix trace, determinant, eigenvalues for small matrices
- **Error source**: Floating-point roundoff in O(1) operations
- **Examples**: `np.trace(ρ)`, `np.linalg.det(U)` for unitary matrices
- **Justification**: Pure algebraic operations with no error accumulation

**Category B: Quantum State Properties (≤ 1e-12)**

- **Mathematical basis**: Purity constraint |trace(ρ²) - 1| < √ε ≈ 1.5e-8
- **Operations**: Hermitian verification, unit trace preservation
- **Error source**: Matrix exponentiation in exponential families
- **Examples**: `np.allclose(ρ, ρ.conj().T)`, `abs(np.trace(ρ) - 1.0)`
- **Justification**: Quantum states must satisfy fundamental constraints

**Category C: Entanglement & Information Metrics (≤ 1e-10)**

- **Mathematical basis**: von Neumann entropy sensitivity to eigenvalue perturbations
- **Operations**: Mutual information I = C - H, marginal entropy sums
- **Error source**: Partial trace operations and eigenvalue computations
- **Examples**: `abs(I - (C - H))`, marginal entropy conservation
- **Justification**: Information-theoretic quantities require high precision

**Category D: Analytical Derivatives (≤ 1e-8)**

- **Mathematical basis**: Error propagation in quantum Fisher information metric
- **Operations**: BKM metric G, Jacobian M, constraint gradients ∇C
- **Error source**: Complex derivative chains and matrix logarithms
- **Examples**: Fisher information symmetry, constraint preservation
- **Justification**: Derivatives amplify small errors in state representations

**Category E: Numerical Integration (≤ 1e-6)**

- **Mathematical basis**: ODE solver convergence and long-time stability
- **Operations**: Trajectory integration, entropy evolution over time
- **Error source**: Accumulation of integration errors over many steps
- **Examples**: Constraint preservation during dynamics, entropy monotonicity
- **Justification**: Physical conservation laws must hold over extended periods

**Category F: Physical Validation (≤ 1e-4)**

- **Mathematical basis**: Statistical significance for physical claims
- **Operations**: Optimality verification, genericity checks
- **Error source**: Parameter space exploration and optimization convergence
- **Examples**: Qutrit optimality claims, phase transition detection
- **Justification**: Research conclusions require robust statistical evidence

### 4. Absolute vs Relative Tolerance Strategy

**Absolute tolerances** for quantities with natural scales:

- Quantum state properties (trace = 1, purity bounds)
- Physical constraints (probability conservation)
- Error metrics with known bounds

**Relative tolerances** for scale-dependent quantities

- Fisher information metrics (can vary by orders of magnitude)
- Entanglement measures (depend on system size)
- Derivative magnitudes (depend on parameter scales)

**Adaptive tolerance selection**

- Small absolute tolerance floor prevents false precision
- Relative tolerance ceiling prevents overly loose bounds
- Context-aware selection based on mathematical operation type

### 5. Coverage Preservation

- Complete mapping of existing tests to new structure
- No reduction in test cases or scenarios
- Enhanced edge case coverage
- Better error message documentation

## Implementation Plan

### Phase 1: Tolerance Analysis and Design (Week 1-2)

1. **Mathematical precision analysis**

   - Review all quantum algorithms for error sources
   - Calculate theoretical error bounds for each operation
   - Document floating-point error accumulation patterns

2. **Current test inventory**

   - Catalog all 19 test files and their coverage
   - Map tests to mathematical requirements
   - Identify redundant or overlapping tests

3. **Tolerance framework design**

   - Define tolerance categories with mathematical justification
   - Create utility functions for consistent tolerance application
   - Design statistical validation methods for tolerance setting

### Phase 2: Core Test Rewrite (Week 3-6)

1. **Unit test restructuring**

   - Rewrite core mathematical tests with justified tolerances
   - Implement tolerance validation utilities
   - Add comprehensive error documentation

2. **Integration test consolidation**

   - Merge overlapping integration tests
   - Standardize integration test tolerances
   - Improve test isolation and reproducibility

3. **Validation test enhancement**

   - Rewrite physical/mathematical validation tests
   - Implement statistical significance testing
   - Add tolerance sensitivity analysis

### Phase 3: Quality Assurance and Documentation (Week 7-8)

1. **Test suite validation**

   - Run comprehensive test suite against all tolerance levels
   - Validate that all original coverage is maintained
   - Performance benchmarking of new test suite

2. **Documentation and guidelines**

   - Create tolerance selection guidelines
   - Document mathematical basis for each tolerance category
   - Update testing documentation with new structure

3. **Migration support**

   - Backward compatibility testing
   - Migration guide for developers
   - Training materials for tolerance rationale

## Backward Compatibility

This rewrite maintains complete backward compatibility at the API level:

- All existing test functionality preserved
- Same test coverage and scenarios
- Compatible with existing CI/CD pipelines
- No changes to tested code interfaces

The only changes are internal to the test suite:
- Reorganized file structure
- Standardized tolerance application
- Enhanced documentation and error messages

## Testing Strategy

### Tolerance Validation

- **Mathematical verification**: Each tolerance backed by error analysis
- **Empirical validation**: Statistical testing of tolerance adequacy
- **Sensitivity analysis**: Understanding test failure patterns

### Coverage Verification

- **Requirement traceability**: Every mathematical requirement has corresponding tests
- **Edge case coverage**: Comprehensive boundary condition testing
- **Regression protection**: All known bugs remain caught by tests

### Performance Monitoring

- **Test execution time**: Ensure rewrite doesn't significantly slow tests
- **Memory usage**: Monitor for efficiency improvements
- **Parallel execution**: Maintain ability to run tests in parallel

## Related Requirements

This CIP addresses the following testing and quality assurance needs:

- Rigorous numerical validation of quantum algorithms
- Maintainable test suite with clear tolerance rationale
- Reliable CI/CD pipeline with meaningful test results
- Developer confidence in test failure diagnosis

Specific requirements implemented by this CIP include:

- Standardized numerical tolerance framework for quantum computations
- Comprehensive test reorganization maintaining full coverage
- Mathematical justification for all numerical thresholds
- Enhanced test maintainability and debugging capabilities

## Implementation Status

### Phase 1: Tolerance Analysis and Design ✅ **COMPLETED**

- [x] Mathematical precision analysis completed
- [x] Current test inventory catalogued
- [x] Tolerance framework designed and implemented
  - Implemented `tests/tolerance_framework.py` with Categories A–F
  - Documented derivations in `docs/cip0004_precision_analysis.md`
  - Created full test inventory in `docs/cip0004_test_inventory.md`

### Phase 2: Core Test Rewrite ✅ **COMPLETED**

- [x] Unit test restructuring
  - [x] Rewrote `test_pair_exponential_family.py` to use the new framework
  - [x] Removed ad hoc tolerances in favour of operation-specific categories
  - [x] Preserved and slightly expanded coverage (23 tests, all passing)
- [x] Numerical validation tests rewritten
  - [x] Rewrote `test_pair_numerical_validation.py` using Categories C/D/E
  - [x] Replaced hand-tuned thresholds with scientifically justified tolerances
  - [x] Left **5 failing tests in place** to highlight analytical implementation bugs:
    - Fisher metric (BKM) analytic vs finite difference
    - Constraint Hessian analytic vs finite difference
    - Constraint gradient convergence for two-pair systems
    - Jacobian analytic vs finite difference
    - Multi-pair ρ-derivative accuracy
  - These failures are **treated as real bugs**, not adjusted away by loosening tolerances.
- [x] All remaining test files converted (17 files total)
  - [x] Converted all BKM test files (5 files): `test_commuting_bkm.py`, `test_non_commuting_bkm.py`, `test_nondiagonal_commuting_bkm.py`
  - [x] Converted third cumulant tests (2 files): `test_third_cumulant.py`, `test_third_cumulant_symmetry.py`
  - [x] Converted constraint/gradient tests (4 files): `test_jacobian.py`, `test_jacobian_analytic.py`, `test_lagrange_multiplier_gradient.py`, `test_marginal_entropy_gradient.py`
  - [x] Converted Hessian tests (2 files): `test_constraint_hessian.py`, `test_constraint_hessian_duhamel.py`
  - [x] Converted remaining validation tests (2 files): `test_theta_only_constraint.py`, `test_quantum_qutrit.py`
  - [x] Converted main test suite: `test_inaccessible_game.py`
- [x] Key improvements:
  - Fixed overly loose tolerance (0.1 → 1e-8) for independent operator covariance
  - Replaced 5% tolerance with proper `fisher_metric` category for symmetry tests
  - Net code reduction: 188 insertions, 196 deletions across all conversions
  - All 17 test files now use scientifically justified tolerances
- [ ] **Next: Test file consolidation** (Backlog: `2025-11-27_consolidate-test-suite-structure.md`)
  - Reorganize test files → 10 files to mirror qig module structure
  - Eliminate redundancy (e.g., qutrit tests duplicating main tests)
  - Improve discoverability and maintainability
  - All 131 tests maintained, better organized by functionality

### Phase 3: Quality Assurance and Documentation ✅ **COMPLETED**

- [x] Test suite validation completed
  - All test files running with tolerance framework
  - 9 consolidated test files + 2 diagnostic scripts
  - Known failures properly documented and categorized
- [x] Core documentation completed
  - `docs/cip0004_precision_analysis.md` - Mathematical derivation of all tolerance categories
  - `docs/cip0004_test_inventory.md` - Complete test suite inventory
  - `tests/tolerance_framework.py` - Comprehensive inline documentation
- [x] **Test suite consolidation completed** (Backlog: `2025-11-27_consolidate-test-suite-structure.md`)
  - Reduced from 19 files → 9 test files mirroring qig module structure
  - All consolidations validated with unchanged test counts
  - Benefits achieved: Better discoverability, reduced redundancy, self-documenting architecture
- [ ] Migration guide for future test development (DEFERRED - see backlog task)
- [ ] Training materials for tolerance selection (DEFERRED - see backlog task)

## Implementation Complete

**Status**: CIP-0004 implementation is complete as of 2025-12-01.

**Achievements**:
- ✅ 9 consolidated test files using scientifically-derived tolerance framework
- ✅ All tests use Categories A-F with mathematical justification
- ✅ Test suite reduced from 19 → 9 files, mirroring `qig` module structure
- ✅ Comprehensive documentation of tolerance derivations
- ✅ Shared finite-difference helpers for consistent validation
- ✅ Known analytical bugs properly surfaced (not hidden by loose tolerances)

**Deferred**: Migration guide and training materials moved to separate backlog task for future enhancement.

## References

**Consolidated Test Suite (10 files):**

All test files use the tolerance framework with scientifically justified bounds, organized to mirror `qig` module structure:

**Core Library Tests:**
1. `test_core_utilities.py` - State utilities, operator bases, GENERIC (~15 tests)
2. `test_exponential_family.py` - Exponential family operations, mathematical properties, qutrit validation (~21 tests)
3. `test_pair_exponential_family.py` - Pair basis operators and numerical validation (~33 tests)

**Derivative Tests:**
4. `test_fisher_metric.py` - Fisher information (BKM) for all operator types (~16 tests)
5. `test_constraint_derivatives.py` - Constraint gradient ∇C, Hessian ∇²C, Lagrange ∇ν (~15 tests)
6. `test_higher_derivatives.py` - Jacobian M and third cumulant ∇³ψ (~13 tests)

**Dynamics & Integration:**
7. `test_dynamics.py` - Constrained dynamics, GENERIC decomposition, integration (~14 tests)

**Performance & Optimization:**
8. `test_theta_only_constraint.py` - θ-only optimization method (~21 tests)

**Diagnostic & Utility:**
9. `test_notebook.py` - Notebook validation tests
10. Additional diagnostic scripts (not pytest): `test_bkm_integral.py`, `test_bkm_spectral_variants.py`

**Diagnostic scripts (not pytest tests):**
- `test_bkm_integral.py` - BKM integral definition exploration
- `test_bkm_spectral_variants.py` - Spectral formula diagnostics

**Mathematical References:**

- Quantum algorithm precision analysis
- Floating-point error propagation theory
- Statistical hypothesis testing for numerical validation

**Related CIPs:**

- **CIP-0001**: Quantum inaccessible game validation consolidation
  - **Overlap**: Test suite rewrite must validate the consolidated code structure
  - **Dependency**: New tolerance framework will test the unified API from CIP-0001
  - **Risk**: Consolidated code may expose new numerical precision requirements

- **CIP-0002**: Audit and migrate legacy scripts to support entangled systems
  - **Overlap**: Must test both local operators (separable states) and pair operators (entangled states)
  - **Critical requirement**: Tolerance categories must work for both I=0 (separable) and I>0 (entangled) systems
  - **Validation**: New tests will verify entanglement metrics with appropriate precision bounds

- **CIP-0003**: Fix critical bugs in analytical implementations
  - **Overlap**: New tolerance framework will validate analytical fixes don't introduce regressions
  - **Dependency**: Precision categories must accommodate corrected Jacobian and BKM implementations
  - **Risk assessment**: Stricter tolerances may reveal remaining analytical issues
